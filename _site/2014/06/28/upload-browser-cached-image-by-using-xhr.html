<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>通过XHR上传浏览器缓存的图片资源 &#8211; Lyfing.Loo's Blog</title>
<meta name="description" content="通过发起XHR请求的方式获取浏览器缓存的图片资源">
<meta name="keywords" content="Tech, Javascript, Chrome-Extension">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="通过XHR上传浏览器缓存的图片资源">
<meta property="og:description" content="通过发起XHR请求的方式获取浏览器缓存的图片资源">
<meta property="og:url" content="http://localhost:4000/2014/06/28/upload-browser-cached-image-by-using-xhr.html">
<meta property="og:site_name" content="Lyfing.Loo's Blog">





<link rel="canonical" href="http://localhost:4000/2014/06/28/upload-browser-cached-image-by-using-xhr.html">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Lyfing.Loo's Blog Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.min.css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">




<style type="text/css">body {background-image:url(http://localhost:4000/images/ps_neutral.png);}</style>


</head>

<body id="post"  itemscope itemtype="http://schema.org/WebPage">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://localhost:4000">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://localhost:4000/images/avatar.jpg" alt="Lyfing.Loo photo" class="author-photo">
					<h4>Lyfing.Loo</h4>
					<p>Hangzhou, China</p>
				</li>
				<li><a href="http://localhost:4000/about/">Learn More</a></li>
				<li>
					<a href="mailto:hellolyfing@gmail.com"><i class="icon-envelope"></i> Email</a>
				</li>
				
				
				
				
				
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://localhost:4000/archive/">All Posts</a></li>
				<li><a href="http://localhost:4000/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
  <article class="hentry" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title" itemprop="name"><a href="http://localhost:4000/2014/06/28/upload-browser-cached-image-by-using-xhr.html" rel="bookmark" title="通过XHR上传浏览器缓存的图片资源" itemprop="url">通过XHR上传浏览器缓存的图片资源</a></h1>
        
        <h2>June 28, 2014</h2>
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content" itemprop="description">
      <p>最近在为公司开发一个<a href="https://chrome.google.com/webstore/detail/obnbgneldjmmpgkbnnbiiinijmiclpaa">海淘的Chrome扩展</a>，扩展的需求之一是：获取当前页面中的某张图片，并将其上传至公司的服务器保存。</p>

<p>当时的第一思路是：</p>

<ul>
  <li>获取图片的URL，然后把URL提交给服务器，让服务器进行下载操作</li>
  <li>如果服务器访问图片资源时被拒绝，就需要让用户手动下载该图片，然后手动上传至我们的服务器</li>
</ul>

<p>不过在后来的实践中发现，其实可以直接通过发起<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest">XHR</a>请求的方式读取图片的缓存，然后将该缓存数据(图片资源)上传至服务器。</p>

<!--more-->

<p><em>在这里首先要说明一点是的：这种将缓存数据当作文件上传的思路，通常是需要<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">跨站请求资源</a>(Cross-site HTTP requests)的，所以除非是在允许跨站请求的运行环境中（如Chrome扩展内）运行这些JS，否则这种思路几乎不可用</em></p>

<h3 id="section">思路</h3>
<p>这种直接通过发起<code>XHR</code>请求来获取图片资源的思路，最先来自这里<a href="http://stackoverflow.com/a/10002486/1241980">upload-a-file-in-a-google-chrome-extension</a>。基本思路是：浏览器对页面渲染时下载的文件(<code>image</code>、<code>css</code>、<code>js</code>)都有缓存，此时可以手动发起一个对页面中某个文件的<code>XHR</code>请求，浏览器会直接从本地缓存中取到数据(上述文件的<a href="http://stackoverflow.com/a/4480318/1241980"><code>Cache-Control</code></a> header一般都标识为可缓存)作为响应，我们则可以把这些数据当作”文件”来上传至服务器。</p>

<hr />

<h3 id="section-1">怎么做</h3>
<p>1) 通过XHR请求一个图片资源</p>

<pre><code>var imgURL = 'http://lyfing.qiniudn.com/external_links/pocker_cards_family.png';
var xhr = new XMLHttpRequest(); 
xhr.open("GET", imgURL, true);
xhr.responseType = "blob";
xhr.onload = function(){
    var blob = xhr.response;
    var msg = ' Request URL = \n ' + imgURL;
    msg += '\n\n Get Response !';
    msg += '\n responseType = ' + blob.type;
    msg += '\n responseSize = ' + Math.round(blob.size / 1024) + 'KB';
    alert(msg);
};
xhr.send();
</code></pre>

<script type="text/javascript">
function getIMGRes(){
    var imgURL = 'http://lyfing.qiniudn.com/external_links/pocker_cards_family.png';
    var xhr = new XMLHttpRequest(); 
    xhr.open("GET", imgURL, true);
    xhr.responseType = "blob";
    xhr.onload = function(){
        var blob = xhr.response;
        var msg = ' Request URL = \n ' + imgURL;
        msg += '\n\n Get Response !';
        msg += '\n responseType = ' + blob.type;
        msg += '\n responseSize = ' + Math.round(blob.size / 1024) + 'KB';
        alert(msg);
    };
    xhr.send();
};
</script>

<p><input type="button" onclick="getIMGRes();" value="点击测试" /></p>

<p>2) 将返回的<a href="https://developer.mozilla.org/en-US/docs/Web/API/Blob">Blob</a>对象上传至服务器</p>

<pre><code>// 直接使用上一步获得的blob对象
var blob = xhr1.response;
// 我们可以直接使用FormData构建Form表单
var formData = new FormData();
// 获取文件类型(例如: blob.type = 'image/png')
var fileType = blob.type.split('/')[1]; 
// 
formData.append('file', blob, 'test001.' + fileType);

var xhr2 = new XMLHttpRequest();

xhr2.upload.onprogress = function(event){
    ...
    $msg2.html('正在上传 ( ' + percent + '% )');
}

xhr2.onload = function(){
    if ( !confirm('上传完成！即将跳转至上传结果页...') ) return;
    // 返回结果是一段纯文本，我们用正则取出本次上传的信息链接
    var url = xhr2.response.match(/http:\/\/[^\s]+/)[0];
    window.open(url);
}

xhr2.open('POST', 'http://posttestserver.com/post.php?dir=example', true);
xhr2.send(formData);
</code></pre>

<script type="text/javascript">
function upload(){
    var imgURL = 'http://lyfing.qiniudn.com/external_links/pocker_cards_family.png';
    var xhr1 = new XMLHttpRequest();
    xhr1.open("GET", imgURL, true);
    xhr1.responseType = "blob";
    xhr1.onload = function(){
        var blob = xhr1.response;
        var formData = new FormData();
        var fileType = blob.type.split('/')[1];
        formData.append('file', blob, 'test001.' + fileType);

        var xhr = new XMLHttpRequest();
        
        xhr.upload.onprogress = function(event){
            var $msg2 = $('#part2Msg');
            var percent = Math.floor(event.position / event.totalSize * 100);
            $msg2.html('正在上传 ( ' + percent + '% )');
        }

        xhr.onload = function(){
            if ( !confirm('上传完成！即将跳转至上传结果页...') ) return;
            var url = xhr.response.match(/http:\/\/[^\s]+/)[0];
            window.open(url);
        }
        
        xhr.open('POST', 'http://posttestserver.com/post.php?dir=example', true);
        xhr.send(formData);        
    };
    xhr1.send(); 
}
</script>

<p><input type="button" onclick="upload();" value="点击测试" /> <span id="part2Msg"></span></p>

<hr />

<h3 id="section-2">用到的一些<code>对象</code></h3>
<p>上面我们用到了<code>FormData</code>对象(<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/FormData">详情</a>)，它是一个模拟了HTML中的Form表单的实体，你可以直接使用它来构建<code>key/value pair</code>，其中的<code>value</code>可以是<code>文件</code>、<code>Blob</code>或者纯<code>String</code>。下面做一个简单的使用示例（Chrome、Firefox可随便使用，IE10+才可使用)</p>

<pre><code>// 创建Form表单对象formData，可在构造函数中传入一个HTML表单对象htmlForm
// 它的键值对会被添加到formData中
var formData = new FormData();
// 添加一个键值对
formData.append('userID', '112233');
// 添加一个文件对象
var file = document.getElementByID('fileField');
formData.append('file1', file);
// 添加一个Blob对象，它将被视为文件上传
formData.append('file2', blob);
</code></pre>

<p>关于<code>Blob</code>对象，它是一个类似于<code>文件</code>的结构体，事实上<code>文件</code>接口正是在它的基础上做的扩展。<a href="https://developer.mozilla.org/en-US/docs/Web/API/Blob">更多关于Blob</a></p>

<hr />
<p><strong>备注</strong>：</p>

<ul>
  <li>
    <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest">跨站请求HTTP资源</a></p>
  </li>
  <li>
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Blob"><code>Blob</code></a>对象</p>
  </li>
  <li>
    <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/FormData"><code>FormData</code></a>对象</p>
  </li>
  <li>
    <p>示例中用到的文件上传服务：http://posttestserver.com/post.php?dir=example</p>
  </li>
  <li>
    <p>示例中用到的图片：<img src="http://lyfing.qiniudn.com/external_links/pocker_cards_family.png" alt="" /></p>
  </li>
</ul>


      <footer class="entry-meta">
        <span class="entry-tags"><a href="http://localhost:4000/tags/index.html#Tech" title="Pages tagged Tech" rel="tag" class="tag">Tech</a><a href="http://localhost:4000/tags/index.html#Javascript" title="Pages tagged Javascript" rel="tag" class="tag">Javascript</a><a href="http://localhost:4000/tags/index.html#Chrome-Extension" title="Pages tagged Chrome-Extension" rel="tag" class="tag">Chrome-Extension</a></span>
        <span><a href="http://localhost:4000/2014/06/28/upload-browser-cached-image-by-using-xhr.html" rel="bookmark" title="通过XHR上传浏览器缓存的图片资源" itemprop="url">通过XHR上传浏览器缓存的图片资源</a> was published on <span class="entry-date date published updated"><time datetime="2014-06-28T00:00:00+08:00" itemprop="datePublished">June 28, 2014</time></span></span>
        
        <span class="author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name" class="fn"><a href="http://localhost:4000/about" title="About Lyfing.Loo" itemprop="url">Lyfing.Loo</a></span></span>
        
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    
    <div class="read-more">
      
        <div class="read-more-header">
          <a href="http://localhost:4000/2014/01/12/Python-a-web-spider-for-fetching-qiubai-articles.html" class="read-more-btn">Read More</a>
        </div><!-- /.read-more-header -->
        <div class="read-more-content">
          <h3><a href="http://localhost:4000/2014/01/12/Python-a-web-spider-for-fetching-qiubai-articles.html" title="Python爬虫 实现从糗百上多线程抓取内容">Python爬虫 实现从糗百上多线程抓取内容</a></h3>
          <p>用Python写的爬虫，可以从糗百上抓取所有文章，并下载相关附图（如果附图的话） <a href="http://localhost:4000/2014/01/12/Python-a-web-spider-for-fetching-qiubai-articles.html">Continue reading</a></p>
        </div><!-- /.read-more-content -->
      
      <div class="read-more-list">
        
          <div class="list-item">
            <h4><a href="http://localhost:4000/2014/01/09/study-on-python-unicode-encoding-stuff.html" title="关于Python的编码、乱码以及Unicode的一些研究">关于Python的编码、乱码以及Unicode的一些研究</a></h4>
            <span>Published on January 09, 2014</span>
          </div><!-- /.list-item -->
        
          <div class="list-item">
            <h4><a href="http://localhost:4000/2013/10/20/Labwindows-tutorial-chapter3-part2.html" title="Labwindows.Tutorial.Chapter 3.Part2">Labwindows.Tutorial.Chapter 3.Part2</a></h4>
            <span>Published on October 20, 2013</span>
          </div><!-- /.list-item -->
        
      </div><!-- /.read-more-list -->
      
    </div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2014 Lyfing.Loo. Powered by <a href="http://jekyllrb.com">Jekyll</a> hosted on Github Pages using the <a href="https://github.com/mmistakes/hpstr-jekyll-theme">HPSTR Theme</a>.</span>

  </footer>
</div><!-- /.footer-wrapper -->

<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"></script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'lyfing521'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	        

</body>
</html>
