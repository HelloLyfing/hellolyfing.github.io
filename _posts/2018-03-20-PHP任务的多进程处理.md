---
layout: post
title: PHP任务的多进程处理
---
<div class="wiki-content">
                           <p></p><div>
<ul>
    <li><span class="TOCOutline">1</span> <a href="#PHP任务的多进程处理-概述">概述</a></li>
    <li><span class="TOCOutline">2</span> <a href="#PHP任务的多进程处理-PHP的多进程管理（PCNTL扩展）">PHP的多进程管理（PCNTL扩展）</a></li>
<ul>
    <li><span class="TOCOutline">2.1</span> <a href="#PHP任务的多进程处理-示例1：简易demo">示例1：简易demo</a></li>
    <li><span class="TOCOutline">2.2</span> <a href="#PHP任务的多进程处理-示例2：实际应用场景初探">示例2：实际应用场景初探</a></li>
</ul>
    <li><span class="TOCOutline">3</span> <a href="#PHP任务的多进程处理-PCNTL扩展进阶使用">PCNTL扩展进阶使用</a></li>
<ul>
    <li><span class="TOCOutline">3.1</span> <a href="#PHP任务的多进程处理-子进程的管理（监控终止子进程）">子进程的管理（监控/终止子进程）</a></li>
    <li><span class="TOCOutline">3.2</span> <a href="#PHP任务的多进程处理-父子进程的信号处理">父/子进程的信号处理</a></li>
    <li><span class="TOCOutline">3.3</span> <a href="#PHP任务的多进程处理-任务（进程）的后台执行">任务（进程）的后台执行</a></li>
</ul>
    <li><span class="TOCOutline">4</span> <a href="#PHP任务的多进程处理-附录：通用PHP任务框架流程图">附录：通用PHP任务框架流程图</a></li>
</ul></div><p></p><h2 id="PHP任务的多进程处理-概述">概述</h2><p>很多以PHP为编程语言的Web项目，在需要做异步业务、数据的处理时，仍然会选择使用PHP语言来编写任务脚本。<span>这么做的优点不言而喻，通用的底层model、业务service、熟悉的公共类及方法，让熟悉Web业务开发的工程师可以花最快的时间以及最小的学习成本快速编写出特定场景的业务脚本。</span></p><p><span>然而PHP是为Web网页制作而生的单进程处理语言，当他遇到大数据场景下的业务数据的处理需求时，如果仍然依靠单进程的方式进行，不仅耗费更多时间、浪费服务器资源，而且可能很快就会遇到性能瓶颈。在这样一种场景需求下，PHP语言的多进行/线程处理能力就显得尤为需要了。<br><br>PHP对多进程处理的支持虽然已经到来了(<a href="https://github.com/krakjoe/pthreads" class="external-link" rel="nofollow">https://github.com/krakjoe/pthreads</a>&nbsp;)，然而它却只能在PHP7.2+以上的版本中运行，而且需要<span style="color: rgb(34,34,34);">Thread Safety特性的支持。在这样一种现状下，使PHP支持多进程处理似乎是唯一（但不是最坏）的选择了。</span></span></p><h2 id="PHP任务的多进程处理-PHP的多进程管理（PCNTL扩展）">PHP的多进程管理（PCNTL扩展）</h2><p><a href="http://php.net/manual/zh/intro.pcntl.php" class="external-link" rel="nofollow">PCNTL扩展</a>&nbsp;实现了类Unix系统中的进程创建、执行、信号处理以及最终的进程终止，更具体的实现方式可以参考类Unix系统提供的<a href="http://man7.org/linux/man-pages/man2/fork.2.html" class="external-link" rel="nofollow">fork(2)</a>、waitpid(2)和signal(2)函数接口。</p><p>贝贝PHP的开发环境默认配置了PCNTL扩展，如果你的环境需要安装或配置该扩展，还请自行查找方法，此处略过。</p><p>对PCNTL扩展有了初步的认识后，我们先来编写一个多进程的demo任务练练手，熟悉一下该扩展中核心函数pcntl_fork的使用场景及方法</p><h4 id="PHP任务的多进程处理-示例1：简易demo">示例1：简易demo</h4><div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div><div id="highlighter_269057" class="syntaxhighlighter nogutter  php"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="php plain">&lt;?php</code></div><div class="line number2 index1 alt1"><code class="php functions">print</code> <code class="php string">"I'm in the Main process!\n"</code><code class="php plain">;</code></div><div class="line number3 index2 alt2"><code class="php plain">&nbsp;</code></div><div class="line number4 index3 alt1"><code class="php comments">// 当前进程：主进程</code></div><div class="line number5 index4 alt2"><code class="php variable">$pid</code> <code class="php plain">= pcntl_fork();</code></div><div class="line number6 index5 alt1"><code class="php comments">// pcntl_fork()被执行后，系统会立即创建子进程，而且子进程的执行入口为紧跟在pcntl_fork()之后的代码，与主进程即将执行的代码一致</code></div><div class="line number7 index6 alt2"><code class="php functions">print</code> <code class="php string">"Who am I ?\n"</code><code class="php plain">;</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="php comments">// 此时需要一种机制或约定来让编程人员判断当前代码执行的环境为主进程中or子进程中</code></div><div class="line number10 index9 alt1"><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$pid</code> <code class="php plain">=== -1) {</code></div><div class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">print</code> <code class="php string">"Fork child process faield, exit!\n"</code><code class="php plain">;</code></div><div class="line number12 index11 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">exit</code><code class="php plain">(1);</code></div><div class="line number13 index12 alt2"><code class="php plain">} </code><code class="php keyword">elseif</code> <code class="php plain">(</code><code class="php variable">$pid</code> <code class="php plain">=== 0) {</code></div><div class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">print</code> <code class="php string">"I'm in the child process!\n"</code><code class="php plain">;</code></div><div class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">print</code> <code class="php string">"Child process exit.\n"</code><code class="php plain">;</code></div><div class="line number16 index15 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">exit</code><code class="php plain">(0);</code></div><div class="line number17 index16 alt2"><code class="php plain">} </code><code class="php keyword">elseif</code> <code class="php plain">(</code><code class="php variable">$pid</code> <code class="php plain">&gt; 0) {</code></div><div class="line number18 index17 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">print</code> <code class="php string">"I'm still in the main process!\n"</code><code class="php plain">;</code></div><div class="line number19 index18 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">print</code> <code class="php string">"Main process exit.\n"</code><code class="php plain">;</code></div><div class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">exit</code><code class="php plain">(0);</code></div><div class="line number21 index20 alt2"><code class="php plain">}</code></div></div></td></tr></tbody></table></div></div>
</div></div><p>上面那段代码的输出会是什么样子呢？</p><div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>运行结果</b></div><div class="codeContent panelContent">
<div><div id="highlighter_525915" class="syntaxhighlighter collapsed nogutter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_expandSource expandSource">expand source</a></span><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="bash plain">[root@1d42e4522359 tmp]</code><code class="bash comments"># php test.php</code></div><div class="line number2 index1 alt1"><code class="bash plain">I'm </code><code class="bash keyword">in</code> <code class="bash plain">the Main process!</code></div><div class="line number3 index2 alt2"><code class="bash plain">Who am I ?</code></div><div class="line number4 index3 alt1"><code class="bash plain">I'm still </code><code class="bash keyword">in</code> <code class="bash plain">the main process!</code></div><div class="line number5 index4 alt2"><code class="bash plain">Main process </code><code class="bash functions">exit</code><code class="bash plain">.</code></div><div class="line number6 index5 alt1"><code class="bash plain">Who am I ?</code></div><div class="line number7 index6 alt2"><code class="bash plain">I'm </code><code class="bash keyword">in</code> <code class="bash plain">the child process!</code></div><div class="line number8 index7 alt1"><code class="bash plain">Child process </code><code class="bash functions">exit</code><code class="bash plain">.</code></div></div></td></tr></tbody></table></div></div>
</div></div><p>从上面的示例代码中可以看出：</p><ul><li>不同于多线程中只会被新线程执行的特定代码块，多进程代码在被执行时，父进程与子进程几乎共用同一份代码，即<span>pcntl_fork()之后的代码</span></li><li>由于子进程被创建之后，父进程与子进程就相当于两个独立的进程，二者共用pcntl_fork()之后的代码，而且执行顺序没有保证，所以需要通过pcntl_fork()函数的返回值来判断当前进程所属父/子进程，以便通过if-else判断为父/子进程预设置不同的执行代码。pcntl_fork()函数的返回值$pid有三种情况：<br><ul><li>$pid = -1: 子进程创建失败，通常情况下子进程创建失败，程序都会记录原因后主动退出</li><li>$pid &gt; 0: 子进程创建成功。当前进程为父进程，其中$pid的值即为刚创建成功的子进程的进程id</li><li>$pid = 0: 子进程创建成功。当前进程为子进程</li></ul></li></ul><h4 id="PHP任务的多进程处理-示例2：实际应用场景初探">示例2：实际应用场景初探</h4><p>下面我们来编写一例有实际应用场景的例子：父<span>进程创建2个子进程，每个子进程的工作内容相同：从主进程分配给自己的网址中抓取网页的标题字段并打印出来，然后退出程序。父进程在sleep几秒（其实是在等待子程序执行完并主动退出）后也退出程序。</span></p><div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div><div id="highlighter_440581" class="syntaxhighlighter  php"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div></td><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="php plain">&lt;?php</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="php keyword">function</code> <code class="php plain">printLine(</code><code class="php variable">$msg</code><code class="php plain">) {</code></div><div class="line number4 index3 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">print</code> <code class="php variable">$msg</code> <code class="php plain">. </code><code class="php string">"\n"</code><code class="php plain">;</code></div><div class="line number5 index4 alt2"><code class="php plain">}</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="php keyword">function</code> <code class="php plain">get_url_title(</code><code class="php variable">$url</code><code class="php plain">) {</code></div><div class="line number8 index7 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$content</code> <code class="php plain">= </code><code class="php functions">file_get_contents</code><code class="php plain">(</code><code class="php variable">$url</code><code class="php plain">);</code></div><div class="line number9 index8 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$match_arr</code> <code class="php plain">= NULL;</code></div><div class="line number10 index9 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$content</code><code class="php plain">) {</code></div><div class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">preg_match(</code><code class="php string">'/&lt;title&gt;(.+?)&lt;\/title&gt;/'</code><code class="php plain">, </code><code class="php variable">$content</code><code class="php plain">, </code><code class="php variable">$match_arr</code><code class="php plain">);</code></div><div class="line number12 index11 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$match_arr</code> <code class="php plain">&amp;&amp; </code><code class="php functions">count</code><code class="php plain">(</code><code class="php variable">$match_arr</code><code class="php plain">) === 2) {</code></div><div class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$match_arr</code><code class="php plain">[1];</code></div><div class="line number16 index15 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></div><div class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php plain">NULL;</code></div><div class="line number18 index17 alt1"><code class="php plain">}</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="php plain">printLine(</code><code class="php string">'Task begin.'</code><code class="php plain">);</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="php variable">$site_urls</code> <code class="php plain">= </code><code class="php keyword">array</code><code class="php plain">(</code></div><div class="line number23 index22 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'<a href="https://www.beibei.com'">https://www.beibei.com'</a></code><code class="php plain">,</code></div><div class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'<a href="https://www.jd.com'">https://www.jd.com'</a></code><code class="php plain">,</code></div><div class="line number25 index24 alt2"><code class="php plain">);</code></div><div class="line number26 index25 alt1">&nbsp;</div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="php keyword">foreach</code><code class="php plain">(</code><code class="php variable">$site_urls</code> <code class="php keyword">as</code> <code class="php variable">$_url</code><code class="php plain">) {</code></div><div class="line number29 index28 alt2">&nbsp;</div><div class="line number30 index29 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$pid</code> <code class="php plain">= pcntl_fork();</code></div><div class="line number31 index30 alt2">&nbsp;</div><div class="line number32 index31 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$pid</code> <code class="php plain">=== -1) {</code></div><div class="line number33 index32 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">printLine(</code><code class="php string">"Fork child process faield, exit!"</code><code class="php plain">);</code></div><div class="line number34 index33 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">exit</code><code class="php plain">(1);</code></div><div class="line number35 index34 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">} </code><code class="php keyword">elseif</code> <code class="php plain">(</code><code class="php variable">$pid</code> <code class="php plain">=== 0) {</code></div><div class="line number36 index35 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">printLine(</code><code class="php string">"In the child process!"</code><code class="php plain">);</code></div><div class="line number37 index36 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">printLine(</code><code class="php variable">$_url</code> <code class="php plain">. </code><code class="php string">' title =&gt; '</code> <code class="php plain">. get_url_title(</code><code class="php variable">$_url</code><code class="php plain">));</code></div><div class="line number38 index37 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">printLine(</code><code class="php string">"Child process exit."</code><code class="php plain">);</code></div><div class="line number39 index38 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">exit</code><code class="php plain">(0);</code></div><div class="line number40 index39 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">} </code><code class="php keyword">elseif</code> <code class="php plain">(</code><code class="php variable">$pid</code> <code class="php plain">&gt; 0) {</code></div><div class="line number41 index40 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">printLine(</code><code class="php string">"In the parent process, do nothing."</code><code class="php plain">);</code></div><div class="line number42 index41 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></div><div class="line number43 index42 alt2"><code class="php plain">}</code></div><div class="line number44 index43 alt1">&nbsp;</div><div class="line number45 index44 alt2"><code class="php variable">$i</code> <code class="php plain">= 7;</code></div><div class="line number46 index45 alt1"><code class="php keyword">while</code> <code class="php plain">(</code><code class="php variable">$i</code><code class="php plain">--) {</code></div><div class="line number47 index46 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">sleep(1);</code></div><div class="line number48 index47 alt1"><code class="php plain">}</code></div><div class="line number49 index48 alt2"><code class="php plain">printLine(</code><code class="php string">"Task end."</code><code class="php plain">);</code></div></div></td></tr></tbody></table></div></div>
</div></div><div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>运行结果</b></div><div class="codeContent panelContent">
<div><div id="highlighter_609586" class="syntaxhighlighter collapsed nogutter  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_expandSource expandSource">expand source</a></span><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="bash plain">[root@1d42e4522359 beibei]</code><code class="bash comments"># php testpcntl.php</code></div><div class="line number2 index1 alt1"><code class="bash plain">Task begin.</code></div><div class="line number3 index2 alt2"><code class="bash plain">In the parent process, </code><code class="bash keyword">do</code> <code class="bash plain">nothing.</code></div><div class="line number4 index3 alt1"><code class="bash plain">In the child process!</code></div><div class="line number5 index4 alt2"><code class="bash plain">In the parent process, </code><code class="bash keyword">do</code> <code class="bash plain">nothing.</code></div><div class="line number6 index5 alt1"><code class="bash plain">In the child process!</code></div><div class="line number7 index6 alt2"><code class="bash plain">https:</code><code class="bash plain">//www</code><code class="bash plain">.beibei.com title =&gt; 贝贝网-买母婴上贝贝！1亿妈妈信赖的母婴正品特卖商城</code></div><div class="line number8 index7 alt1"><code class="bash plain">Child process </code><code class="bash functions">exit</code><code class="bash plain">.</code></div><div class="line number9 index8 alt2"><code class="bash plain">https:</code><code class="bash plain">//www</code><code class="bash plain">.jd.com title =&gt; 京东(JD.COM)-正品低价、品质保障、配送及时、轻松购物！</code></div><div class="line number10 index9 alt1"><code class="bash plain">Child process </code><code class="bash functions">exit</code><code class="bash plain">.</code></div><div class="line number11 index10 alt2"><code class="bash plain">Task end.</code></div></div></td></tr></tbody></table></div></div>
</div></div><p>从上面的执行结果中我们又可以总结出PCNTL扩展函数的几个特点：</p><ul><li><span>1）子进程可以使用（继承了）父进程Context中的变量（如$_url）以及函数（如get_url_title()方法）</span></li><li><span>2）如果移除父进程最后的sleep代码你会发现，子进程在父进程退出后依然可以正常运行，并不会随主进程的退出而退出</span></li></ul><h2 id="PHP任务的多进程处理-PCNTL扩展进阶使用">PCNTL扩展进阶使用</h2><h4 id="PHP任务的多进程处理-子进程的管理（监控终止子进程）">子进程的管理（监控/终止子进程）</h4><p>在实际的任务框架编写中，开发者通常会首先创建一个master进程，然后再由master进程创建N个子进程。其中每个子进程作为工作进程（worker process）进行实际的业务处理，master进程作为管理者，主要负责工作进程的调度、监管、维护、回收等内容。<span>到了某个具体业务处理的场景下，对应业务的开发者仅需要完成自己业务逻辑部分，并将其作为工作进程的一部分，即可快速嵌入到整体的任务框架中去。</span></p><p>在这种任务框架模式下，master进程对子进程的监控及控制能力就显得尤为重要了。那么如何借用PCNTL扩展的函数接口对子进程进行监管与控制呢？</p><p>对子进程的监控，主要分两个方面：1）需要记录每个子进程的进程ID；2）可以通过子进程的进程ID获取子进程的运行状态（是否已结束、是否为僵尸进程）</p><p>对子进程的控制，主要是指：可以通过子进程的进程ID获取其运行状态，并可以停止或中断其运行。</p><ul><li><span style="font-size: 10.0pt;">获取子进程运行状态，需要用到函数<strong>pcntl_waitpid</strong>(int $pid, int &amp;$status, int $options = 0)。本函数依赖于Linux系统的waitpid(2)函数的实现，作用为：阻断当前进程直到给定$pid的子进程退出（当遇到系统信号需要终止运行或调用信号处理函数时会转去进行信号处理）。注意该函数默认是阻塞型函数（除非$options设置为<em>WNOHANG</em>），其会根据入参的不同，做出多种可能的处理和返回（不过由于当前进程通常都为管理子进程的父进程，并非worker进程，所以即便阻塞也没关系）。参数解释：</span><ul><li>$pid：根据$pid值的范围进行不同的处理：<br><ul><li>$pid &lt; -1: 等待指定进程组ID下所有子进程的退出。其中进程组ID = abs($pid)，即$pid的绝对值</li><li>$pid = -1: 等待任意子进程（这里不太清楚，任意是指：用户空间的所有fork出的子进程？）的退出</li><li>$pid =&nbsp; 0: 等待指定进程组ID下所有子进程的退出。其中进程组ID = 当前进程的进程组ID</li><li>$pid &gt;&nbsp; 0: 等待进程ID为$pid的<span>子进程退出</span></li></ul></li><li>$status会在调用结束后被赋予子进程的状态信息，对$status结果的判断可以使用以下函数：</li><ul><li>pcntl_wifexited($status): 判断子进程是否正常退出&nbsp;</li><li>pcntl_wifstopped($status): 判断子进程是否已停止</li><li>pcntl_wstopsig($status): 获取导致子进程停止（stop）的信号(signal)，当pcntl_wifstopped返回TRUE时使用</li><li>pcntl_wifsignaled($status): 判断子进程是否由于某信号而退出</li><li>pcntl_wtermsig($status): 获取导致子进程终止运行（terminate）的信号（signal），当pcntl_wifsignaled返回TRUE时使用</li><li>pcntl_wexitstatus($status): 获取已终止子进程的退出值（exit_code）</li></ul><li>$options: 默认无需设置。但想要使用下面两种值需要<span>系统</span>底层支持。参数<span>使用背景：</span><span style="color: rgb(36,39,41);">子进程退出时，内核会保存子进程的退出状态信息，直到父进程来消费这个状态信息，内核保存的状态信息即可释放</span><br><ul><li><span style="color: rgb(36,39,41);">WNOHANG 作用：如果父进程不想阻塞式获取子进程状态可传入该值，则如果没有子进程退出，本次函数调用会立即return 0</span></li><li><span style="color: rgb(36,39,41);"><span style="color: rgb(36,39,41);">WUNTRACED 作用：返回：进程已经stop了，但状态信息未被消费（取走）的子进程$pid</span></span></li></ul></li><li>@return: 本次函数调用有3中返回结果，他们分别是：<br><ul><li>result &gt; 0: 返回值为：已退出的子进程的进程ID</li><li>result = -1: 函数调用出错</li><li>result = 0: 当使用<span style="color: rgb(36,39,41);">WNOHANG选项，并且无子进程退出时会返回0</span></li></ul></li></ul></li></ul><h4 id="PHP任务的多进程处理-父子进程的信号处理">父/子进程的信号处理</h4><h4 id="PHP任务的多进程处理-任务（进程）的后台执行">任务（进程）的后台执行</h4><p><span><br></span></p><p><span>未完待续...</span></p><h2 id="PHP任务的多进程处理-附录：通用PHP任务框架流程图">附录：通用PHP任务框架流程图</h2><p>通用PHP任务框架流程图：<a href="http://7b1gf6.com1.z0.glb.clouddn.com/PHP%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%BB%BB%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE.svg">PHP多进程任务流程图.svg</a></p>
    
        </div>
