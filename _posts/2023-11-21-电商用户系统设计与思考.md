---
layout: post
title: 电商中的用户系统设计与思考

tags: [电商系统,用户系统,系统设计]
---

# 概述
在电商系统中，用户系统通常都是一个较为核心的系统。由于用户系统产品、功能较多，我自己总结了下，把它归类为三大部分，分别是：用户账号体系、用户登录鉴权体系、用户信息服务体系。

这三大体系中，一、账号体系是用户生态系统的"底座"，它决定了账号的定位方式和唯一性，当公司需要账号体系能够横向多主体(多公司)扩张，或者可以纵向细分隔离时，账号体系底层设计的扩展性和适配性就面临着考验。

二、登录鉴权体系是用户生态系统、乃至全链路系统中对安全性和可用性要求最高的一个，当登录系统脆弱不堪一击时，则安全性无法保证；而当登录系统不稳定、不可用时，整个电商系统最重要的入口则立即对未登录用户显得不可用了。该体系中还有2个重要的服务：Session服务和鉴权服务。

三、用户信息服务体系，通常是指分布式的RPC服务，可以提供高并发和高可用的用户信息服务，它和其他重要的RPC服务（如商品服务、库存服务、商家服务）共同组建出基础服务集群，为高流量、高并发的电商交易核心链路提供稳定可靠的RPC服务。

下面我来分开讲下这三个体系设计的一些思考。

# 一、用户账号体系
用户账号体系设计，最主要的一个问题是：如何确定账号的定位方式和唯一性。定位方式，比如通过手机号定位、通过用户名定位、通过邮箱定位、通过微信openId定位等等。唯一性，是说通过上述定位方式定位出的账号，最终指向了系统内的同一个账号，还是多个账号？
上面对账号的定义，是以一个数字账号的视角来思考的。其实我们也可以换一个自然人的视角来思考这个问题，同样一个自然人，在不同场景下登录获取的账号是否一致。

我们来画张图梳理下这个疑问。

![图1](/images/2023-11/2311-userAccountDesign-1.png){:width="75%"}

我司在环球捕手这个产品开发的时候，就使用了比较简单的账号模型：分为：微信登录来的账号（以微信unionId定位）和手机登录的账号（以手机号定位）。这样开发起来较为简单，但当这两个账号背后，是同一个自然人的时候，由于两个账号的独立性（比如头像昵称简介各自独立），以人的视角来体验这两个账号，就有点让用户伤脑筋和不太理解了。比如换了头像，登录进去发现还是老头像（因为两个账号独立的，没有做关联）；查看个人收货地址和订单的时候，也会容易“受挫”，明明刚刚下的订单，却找不到了。其实这种双账号独立的情况，虽然开发成本较低，但后期的运营成本（用户疑惑、用户咨询、客服答疑）并不低。所以后期我司对这两个账号进行了合并，手机号账户作为主账户，原微信账号可以通过三方账号关联的方式登录手机号主账户。事实上大部分公司也是这么设计账号体系的，如下图所示：

![图2](/images/2023-11/2311-userAccountDesign-2.png){:width="75%"}

**我来总结下上述内容**：当一个账号体系有不同来源的唯一Id可以作为定位依据时（比如手机号、微信unionId、QQ的openId），最好使用跟外部平台无关的个人ID（比如手机号、邮箱、用户名）作为主账号。另外为了实现便捷的三方登录（比如微信登录、QQ登录），只需将主账号和这些三方登录平台的平台Id做绑定即可，实际登录的仍然是外部平台无关的主账号。

至于使用什么个人ID作为账号定位依据，则需要看情况了。有些账号系统中，手机号、邮箱、用户名三种定位方式只能定位到同一个账号，而有些账号系统中，上述三种定位方式则可以定位到三个不同的账号。比如在论坛、UGC领域，或者用户对技术和系统有一定了解的领域，多账号可以提供更多的独立隔离空间，此时三种定位方式对应三个不同账号也是可以的（虽然为了实名制要求，账号系统这会都需要经过手机号认证）。再比如在财经领域、电商领域，移动App领域，通常一个自然人有一个独立账号可以完成理财、网上购物就足够了，而且一个账号信息集中度高，不容易搞混搞串，让用户使用起来也更轻松好记一些。

现在我们来看另一个问题，同一集团下多个子公司有多个独立产品时（比如：阿里旗下的淘宝和闲鱼），面对每个独立产品，同一自然人，或者更细点说同一手机号，是分别对应一个独立账户，还是多个产品共享同一个账户？

从开发便捷性来讲，特别是公司想要复制一个新App出来时，多个独立产品共享同一个账户，有关用户信息增删改查的大部分代码都不用动，用户在多个产品中共享同一个账号和ID，用户系统的工作会完成的特别有“效率”。而且当用户使用新的产品时，头像昵称都会自动继承过来，让用户没有上手成本。

但是，当用户需要针对特定产品更换头像、昵称时，由于账户是共享的，导致其在产品B里更换了头像昵称之后，产品A里的头像昵称也被更新了，这通常是不能接受的。此时，聪明的你可能已经想到了，把头像、昵称、个人简介等个性化的数据从用户基础账号里抽离出来，是不是就可以了？多个个性化数据对应多个产品，底层则公用一个账号和ID。这种设计看上去没什么问题了。

但新的问题仍然会出现。由于我国工信部要求所有产品(App)都要提供账号注销的功能，如果多个产品底层公用一个账号，那么当用户在产品B中注销了账号后，TA在产品A中的账号同时也会被注销（因为底层是一个账号），继而导致TA在产品A中的信息也都随之丢失了（比如收货地址和订单）。

**综上所述**，为了用户账号在其生命周期中的独立性，每个产品最好有一套独立的账号系统。如果一个集团想要跨多个产品做用户统计、分析或者营销，可以想办法在底层将每个产品对应的账号建立关联即可。


# 二、用户登录鉴权体系
本节我分为6个部分来一一讨论。它们分别是：
 - 2.1 身份认证、Cookie与Session；
 - 2.2 权限鉴定服务；
 - 2.3 统一登录的原理；
 - 2.4 三方登录的原理；
 - 2.5 手机号快速登录的原理
 - 2.6 登录安全性,常见的登录攻击；

## 2.1 身份认证、Cookie与Session；
身份认证过程，意即登录过程，是任何一个包含个人信息的IT系统必备的一个核心功能。

登录认证的过程，有的很简单，比如输入一个账号名即可认证；通常情况下认证都需要输入账号 + 密码；稍微复杂点的在上一步基础上可能还有人机验证（防止你通过脚本机器人进行登录攻击，比如极验的拼图验证）；更复杂点的，在上一步基础上还要进行手机短信验证，或者二次验证码验证（2FA）；银行系统、政务系统(如浙里办)，在上一步基础上还要进行视频人脸验证。微信的登录认证，如果在新设备上进行时，过程更复杂一些，认证过程还需要3个日常好友的协助才可以完成，这无疑也更安全一些。

登录认证的目的，是为了证明你对云端的数字账号资产的所有权。登录认证成功的标志，则是该系统给你颁发了一张在一定时间内有效的访问凭证，通过这个凭证，你可以对凭证背后的数字账号资产进行合法的所有权操作(增删改查)。

相反的，你也可以通过登出/注销的操作，来销毁和停用该系统给你颁发的那张访问凭证。

上面一段话，其实就是对一个IT系统的登录系统功能的抽象概述。

登录认证过程的设计，要结合实际场景和安全度要求，平衡好“便捷性”和“安全性”这两点。








