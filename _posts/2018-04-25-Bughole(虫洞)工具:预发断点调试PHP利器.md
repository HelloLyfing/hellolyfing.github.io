---
layout: post
title: Bughole(虫洞)工具:预发断点调试PHP利器
---

<div class="wiki-content">
                           <h2 id="Bughole虫洞工具：预发断点调试PHP利器-true"><div>
<ul>
    <li><span class="TOCOutline">1</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-效果图">效果图</a></li>
    <li><span class="TOCOutline">2</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-试用">试用</a></li>
<ul>
    <li><span class="TOCOutline">2.1</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-debug获取评价列表API- BeibeiItemRateGet">debug: 获取评价列表API -&nbsp;BeibeiItemRateGet</a></li>
    <li><span class="TOCOutline">2.2</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-debugProductTestTask任务product-module ">debug: ProductTestTask任务(product-module)<span style="font-size: 10.0pt;">&nbsp;</span></a></li>
</ul>
    <li><span class="TOCOutline">3</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-实战">实战</a></li>
<ul>
    <li><span class="TOCOutline">3.1</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-实战1：debug任意URL">实战1：debug任意URL</a></li>
    <li><span class="TOCOutline">3.2</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-实战2：debugPHP任务（同上方debugProductTestTask）">实战2：debug PHP任务（同上方debug ProductTestTask）</a></li>
    <li><span class="TOCOutline">3.3</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-遇到问题要反馈？">遇到问题要反馈？</a></li>
</ul>
    <li><span class="TOCOutline">4</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-预发布如何部署">预发布如何部署</a></li>
    <li><span class="TOCOutline">5</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-Bughole原理">Bughole原理</a></li>
<ul>
    <li><span class="TOCOutline">5.1</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-工程结构图">工程结构图</a></li>
    <li><span class="TOCOutline">5.2</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-时序图">时序图</a></li>
</ul>
    <li><span class="TOCOutline">6</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-安全考虑">安全考虑</a></li>
    <li><span class="TOCOutline">7</span> <a href="#Bughole虫洞工具：预发断点调试PHP利器-项目源码">项目源码</a></li>
</ul></div></h2><h2 id="Bughole虫洞工具：预发断点调试PHP利器-效果图">效果图</h2><p>Bughole工具实现了PHPStorm中<span>95%以上</span>的debug功能。借助该工具在预发布调试：PHP的业务代码、API甚至任务脚本，都将变得极为方便！</p><p><img class="confluence-embedded-image confluence-content-image-border" width="900" src="http://wx1.sinaimg.cn/large/6480dca9ly9fr2nh08b2kj218g0s6tog.jpg"></p>

<h2 id="Bughole虫洞工具：预发断点调试PHP利器-试用">试用</h2><p>Bughole整套工具在预发9已经部署完备，以下步骤将分别演示：1）debug获取评价列表的API；2）debug PHP
任务</span></p><h3 id="Bughole虫洞工具：预发断点调试PHP利器-debug获取评价列表API-&nbsp;BeibeiItemRateGet">debug: 获取评价列表API -&nbsp;BeibeiItemRateGet</h3><ol><li>打开bughole UI：<a href="" class="external-link" rel="nofollow">#(暂不对外开放)</a>&nbsp;，<strong>并且确认自己已经连上了预发9</strong></li><li>添加断点。在断点模块，点击“Add”按钮，新增断点信息(可通过类似方式不断增加断点)</li><ol><li><span class="input-group-addon" style="color: rgb(85,85,85);">文件路径：***/***/api/BeibeiItemRateGet.php</span></li><li><span class="input-group-addon" style="color: rgb(85,85,85);"><span class="input-group-addon" style="color: rgb(85,85,85);">断点行号：26<br></span></span></li><li><span style="color: rgb(85,85,85);">填好断点信息，点击确定</span></li></ol><li><span style="color: rgb(85,85,85);">点击“建立连接”按钮。则服务端agent开始监听Xdebug的拦截信息</span></li><li><span style="color: rgb(85,85,85);"><span style="color: rgb(85,85,85);">在新标签页访问：</span></span><a href="http://sapi.beibei.com/item/rate/0-27221145-1-10-1.html?preview=1&amp;XDEBUG_SESSION_START=1" style="font-size: 10.0pt;" class="external-link" rel="nofollow">http://sapi.beibei.com/item/rate/0-27221145-1-10-1.html?preview=1&amp;XDEBUG_SESSION_START=1</a>&nbsp;。这个访问也必须是预发9的！此时Xdebug会尝试拦截这个访问，具体表现为：页面hanging转圈不返回</li><li>回到bughole UI，点击页面顶端的“点我测试”按钮。如果一切正常，你将看到如下图所示信息，这表明Xdebug已经正确开始了</li><li>试试StepOver命令，StepInto命令，StepOut命令？当然你也可以使用RunToLine命令。<br>想查看当前Context的变量信息，就在右侧的Context面板查找吧。右下方还有调用栈信息<br>最后，<strong>一定要记得点击“Stop”按钮停止debug</strong><br><img class="confluence-embedded-image confluence-content-image-border" width="500" src="http://wx2.sinaimg.cn/large/6480dca9ly9fr2osazim8j20z00oogyl.jpg"></li></ol>

<h3 id="Bughole虫洞工具：预发断点调试PHP利器-debugProductTestTask任务product-module&nbsp;">debug: ProductTestTask任务(product-module)<span style="font-size: 10.0pt;">&nbsp;</span></h3><ol><li>打开bughole UI：<a href="#" class="external-link" rel="nofollow">#（暂不对外开放）</a>&nbsp;，<strong>并且确认自己已经连上了预发9</strong></li><li>添加断点。在断点模块，点击“Add”按钮，新增断点信息(可通过类似方式不断增加断点)</li><ol><li><span class="input-group-addon" style="color: rgb(85,85,85);">文件路径：***/***/src/task/ProductTestTask.php</span></li><li><span class="input-group-addon" style="color: rgb(85,85,85);">断点行号：17<br></span></li><li><span style="color: rgb(85,85,85);">填好断点信息，点击确定</span></li></ol><li>点击“建立连接”按钮。则服务端agent开始监听Xdebug的拦截信息</li><li><p>在预发9机器上依次执行：</p>
    <div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div><div id="highlighter_722052" class="syntaxhighlighter nogutter  bash"><div class="toolbar"><span></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="bash comments"># 切换到root用户</code></div><div class="line number2 index1 alt1"><code class="bash functions">sudo</code> <code class="bash functions">su</code></div><div class="line number3 index2 alt2"><code class="bash comments"># 为root用户设置环境变量(设置后Xdebug会主动拦截PHP脚本的运行)</code></div><div class="line number4 index3 alt1"><code class="bash functions">export</code> <code class="bash plain">XDEBUG_CONFIG=</code><code class="bash string">"idekey=bughole"</code></div><div class="line number5 index4 alt2"><code class="bash comments"># 执行任务（切记不要加sudo）</code></div><div class="line number6 index5 alt1"><code class="bash functions">bash</code> <code class="bash plain">/task/task_admin</code><code class="bash plain">.sh start --module=product ProductTestTask&nbsp;</code></div></div></td></tr></tbody></table></div></div>
</div></div><p><br><br></p></li><li>回到bughole UI，点击页面顶端的“点我测试”按钮。如果一切正常，你将看到如上图所示信息，这表明Xdebug已经正确开始了</li><li><span>试试StepOver命令，StepInto命令，StepOut命令？当然你也可以使用RunToLine命令。</span><br><span>想查看当前Context的变量信息，就在右侧的Context面板查找吧。右下方还有调用栈信息</span><br><span>最后，</span><strong>一定要记得点击“Stop”按钮停止debug</strong><br><br></li></ol><p><span style="font-size: 10.0pt;">说明：debug模式同一时间只允许一个人进行debug，如果有其他人也在debug，则可能出现错乱情况。</span><span style="font-size: 10.0pt;">解决办法：1）避免同时使用debug；2）如果debug已经不正常，尝试重启：kill这个任务（python bughole/agent.py);重新运行:&nbsp;python /tmp/tiny-scripts/bughole/agent.py (无需sudo)</span></p><h2 id="Bughole虫洞工具：预发断点调试PHP利器-实战">实战</h2><h3 id="Bughole虫洞工具：预发断点调试PHP利器-实战1：debug任意URL">实战1：debug任意URL</h3><p>详细步骤，请参考：debug获取评价列表API。</p><p>上方步骤4中触发Xdebug启动拦截的关键在于：URL后面要增加一个query（GET、POST皆可）:&nbsp;<u>XDEBUG_SESSION_START=1</u> 即可触发调试模式</p><p>&nbsp;</p><p>当然，很多API接口会<u>对请求参数中的sign做安全校验</u>，意即URL的GET参数不能随意增删，否则会报错：sign校验失败。遇到这种情况，可以通过在<u>Cookie中添加参数触发Xdebug启动</u></p><p><strong>情况1：</strong>如果你在Chrome浏览器中，可以通过Cookie管理工具为当前API域名添加Cookie:&nbsp;XDEBUG_SESSION = 1, HX-BETA = 9；或者直接在网页console中输入: document.cookie = 'HX-BETA=9; XDEBUG_SESSION=1;'&nbsp; &nbsp;然后接着上述步骤4的指示继续即可</p><p><strong>情况2：</strong>如果你在Charlse中，可以通过Rewrite工具为API添加Cookie，然后接着上述步骤4的指示继续即可</p>

<h3 id="Bughole虫洞工具：预发断点调试PHP利器-实战2：debugPHP任务（同上方debugProductTestTask）">实战2：debug PHP任务（同上方debug ProductTestTask）</h3><p>步骤参考debug ProductTestTask任务。<span>触发Xdebug启动拦截的关键在于：当前用户的环境变量中设置了:&nbsp;<u>XDEBUG_CONFIG=idekey=bughole</u>&nbsp;这个变量（使用env命令可以查看当前用户空间的变量）</span></p><p>由于通过sudo export命令设置环境变量会失败，所以需要切换到root用户运行任务脚本。</p><p>注意：<span>多进程的任务(worker_num &gt;= 2)在debug时会出现异常，解决办法：debug时将worker_num设为1，debug完成后再改回原值。</span></p><h3 id="Bughole虫洞工具：预发断点调试PHP利器-遇到问题要反馈？">遇到问题要反馈？</h3><p>遇到使用问题，烦请联系我qq: 379396993, 我会尽快帮忙查看问题</p><h2 id="Bughole虫洞工具：预发断点调试PHP利器-预发布如何部署">预发布如何部署</h2><p>1）拉取agent代码。注意将 GitLab用户名 替换为自己的用户名</p><div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div><div id="highlighter_530619" class="syntaxhighlighter nogutter  java"><div class="toolbar"><span></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="java plain">cd /tmp</code></div><div class="line number2 index1 alt1"><code class="java plain">git clone http:</code><code class="java comments">//GitLab用户名@git.husor.com/dongxu.lu/tiny-scripts.git</code></div></div></td></tr></tbody></table></div></div>
</div></div><p>2）安装Xdebug（如果已安装请跳过本步）</p><div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div><div id="highlighter_392489" class="syntaxhighlighter nogutter  java"><div class="toolbar"><span></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="java plain"># 查看是否安装Xdebug，如果已安装请跳过本步</code></div><div class="line number2 index1 alt1"><code class="java plain">/opt/php-</code><code class="java value">7.1</code><code class="java plain">.</code><code class="java value">9</code><code class="java plain">/bin/php -m |grep Xdebug</code></div><div class="line number3 index2 alt2"><code class="java plain">&nbsp;</code></div><div class="line number4 index3 alt1"><code class="java plain"># copy编译好的扩展至PHP指定目录</code></div><div class="line number5 index4 alt2"><code class="java plain">cp /tmp/tiny-scripts/bughole/xdebug.so /opt/php-</code><code class="java value">7.1</code><code class="java plain">.</code><code class="java value">9</code><code class="java plain">/lib/php/extensions/no-debug-non-zts-</code><code class="java value">20160303</code><code class="java plain">/</code></div><div class="line number6 index5 alt1"><code class="java plain">&nbsp;</code></div><div class="line number7 index6 alt2"><code class="java plain"># 新建文件: /opt/php-</code><code class="java value">7.1</code><code class="java plain">.</code><code class="java value">9</code><code class="java plain">/etc/conf.d/xdebug.ini , 内容如下</code></div><div class="line number8 index7 alt1"><code class="java plain">zend_extension = xdebug.so</code></div><div class="line number9 index8 alt2"><code class="java plain">xdebug.remote_enable = </code><code class="java value">1</code></div><div class="line number10 index9 alt1"><code class="java plain">xdebug.remote_connect_back = </code><code class="java value">0</code></div><div class="line number11 index10 alt2"><code class="java plain">xdebug.remote_host = </code><code class="java value">127.0</code><code class="java plain">.</code><code class="java value">0.1</code></div><div class="line number12 index11 alt1"><code class="java plain">xdebug.remote_port = </code><code class="java value">21733</code></div><div class="line number13 index12 alt2"><code class="java plain">xdebug.remote_handler = dbgp</code></div><div class="line number14 index13 alt1"><code class="java plain">xdebug.remote_mode = req</code></div><div class="line number15 index14 alt2"><code class="java plain">xdebug.remote_autostart = </code><code class="java value">0</code></div><div class="line number16 index15 alt1"><code class="java plain">xdebug.idekey = </code><code class="java string">"bughole"</code></div><div class="line number17 index16 alt2"><code class="java plain">&nbsp;</code></div><div class="line number18 index17 alt1"><code class="java plain"># 重启PHP-FPM</code></div><div class="line number19 index18 alt2"><code class="java plain">service php-fpm-</code><code class="java value">7</code> <code class="java plain">restart</code></div></div></td></tr></tbody></table></div></div>
</div></div><p>3）agent持久运行</p><div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div><div id="highlighter_666068" class="syntaxhighlighter nogutter  java"><div class="toolbar"><span></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="java plain">python /tmp/tiny-scripts/bughole/agent.py &gt; /tmp/bughole-agent.log </code><code class="java value">2</code><code class="java plain">&gt;&amp;</code><code class="java value">1</code> <code class="java plain">&amp;</code></div></div></td></tr></tbody></table></div></div>
</div></div><p class="p1">4）部署已完成。确认agent已运行</p><div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div><div id="highlighter_831199" class="syntaxhighlighter nogutter  java"><div class="toolbar"><span></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="java plain"># agent会返回OK</code></div><div class="line number2 index1 alt1"><code class="java plain">curl http:</code><code class="java comments">//127.0.0.1:21734</code></div></div></td></tr></tbody></table></div></div>
</div></div>

<h2 id="Bughole虫洞工具：预发断点调试PHP利器-Bughole原理">Bughole原理</h2><h3 id="Bughole虫洞工具：预发断点调试PHP利器-工程结构图">工程结构图</h3><p><img class="confluence-embedded-image confluence-content-image-border" width="900" src="http://wx4.sinaimg.cn/large/6480dca9gy1fr2oyic41bj211m0mqq5k.jpg"></p>

<h3 id="Bughole虫洞工具：预发断点调试PHP利器-时序图">时序图</h3><p>以最常用的StepOver(下一行)命令的执行时序作为示例</p><p><img class="confluence-embedded-image confluence-content-image-border" width="900" src="http://wx2.sinaimg.cn/large/6480dca9gy1fr2ozus21pj21bu0tc783.jpg"></p>

<h2 id="Bughole虫洞工具：预发断点调试PHP利器-安全考虑">安全考虑</h2><p>Bughole未提供<strong>eval接口</strong>，所有操作都为“读”操作，不会对线上业务数据造成污染</p><p>待本周发布上线试用几天后会及时更新使用和部署(Agent)文档</p>

<h2 id="Bughole虫洞工具：预发断点调试PHP利器-项目源码">项目源码</h2>
暂不对外开放，如有需要请电邮我
</div>
